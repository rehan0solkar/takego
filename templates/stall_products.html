<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Stall Products</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='common.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
{% extends "layout.html" %}

{% block title %}Stall Products{% endblock %}

{% block content %}
<div id="toast" class="toast hidden"></div>
<header class="navbar">
    <h1 class="logo">Products</h1>
    <nav>
        <a href="/customer">Back</a>
    </nav>
</header>
<input id="search" onkeyup="filterProducts('search', '.product-card')" placeholder="Search products">

<div class="product-grid">
    {% for p in products %}
    <div class="product-card">

        {% if p[5] %}
        <img
  src="{{ url_for('static', filename='uploads/' ~ p.image) }}"
  alt="{{ p.name }}"
  style="width:100%; height:180px; object-fit:cover;"
>
            
        {% else %}
            <img src="{{ url_for('static', filename='icons/no-image.png') }}" class="product-img">
        {% endif %}

        <h3>{{ p[1] }}</h3>

        <p class="price">‚Çπ{{ p[2] }}</p>
        <p class="prep">‚è± {{ p[3] }} mins</p>
        <p>Current Token: <span id="liveToken"></span></p>

        {% if p[4] > 0 %}
            <span class="badge in">In Stock ({{ p[4] }})</span>

            <input type="number"
                   id="qty-{{ p[0] }}"
                   min="1"
                   max="{{ p[4] }}"
                   value="1"
                   class="qty-input">

            <button class="generate-token-btn"
                    data-product-id="{{ p[0] }}"
                    data-qty-id="qty-{{ p[0] }}">
                Generate Token
            </button>

        {% else %}
            <span class="badge out">Out of Stock</span>
        {% endif %}

    </div>
    {% endfor %}
</div>

<script>
const toast = document.getElementById("toast");

function showToast(message) {
  toast.innerText = message;

  // reset state
  toast.classList.remove("hidden");

  // force browser repaint
  void toast.offsetWidth;

  setTimeout(() => {
    toast.classList.add("hidden");
  }, 2500);
}


document.addEventListener("click", function(e) {
    if (e.target.classList.contains("generate-token-btn")) {

        e.target.disabled = true;

        const productId = e.target.dataset.productId;
        const qtyInputId = e.target.dataset.qtyId;
        const quantity = document.getElementById(qtyInputId).value;

        fetch("/generate_token", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `product_id=${productId}&quantity=${quantity}`
        })
        .then(res => res.json())
        .then(data => {

            // üî¥ LOGIN REQUIRED CASE
            if (data.error === "login_required") {
                showToast("Please login first");
                e.target.disabled = false;
                return;
            }

            // ‚úÖ SUCCESS
            if (data.success) {
                setTimeout(() => {
                    window.location.reload();
                }, 800);
            } 
            // ‚ùå OTHER ERRORS
            else {
                e.target.disabled = false;
            }
        })
        .catch(() => {
            e.target.disabled = false;
        });
    }
});
</script>
{% endblock %}

</body>
</html>
